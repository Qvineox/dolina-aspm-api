edition = "2023";

package dolina.defects.v1;

option go_package = "gitlab.domsnail.ru/dolina/dolina-aspm-api/api/gen/go/defects/v1;defects_v1";
option features.(pb.go).api_level = API_OPAQUE;
option features.field_presence = IMPLICIT;

import "protoc-gen-openapiv2/options/annotations.proto";
import "google/protobuf/timestamp.proto";
import "google/protobuf/go_features.proto";

import "defects/v1/fix.proto";
import "cve/v1/cve.proto";

message Defect {
  option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_schema) = {
    json_schema: {
      title: "Defect"
      description: "Represents a security defect (vulnerability) identified and tracked within Dolina ASPM. "
          "This is the primary entity for managing vulnerabilities, containing enriched information "
          "including custom ASPM status, references (e.g., CVE, CWEs), known exploits, an activity log "
          "for audit trail, and various internal metadata generated by the ASPM engine during analysis "
          "and remediation workflows."
    }
  };

  bytes uuid = 1; // internal aspm correlation uuid

  string title = 2;
  string description = 3;

  DefectType type = 4;
  repeated DefectStatus status_list = 5;

  // applied risk score is based on inputs from security scanners and applied ruleset
  uint32 applied_risk_score = 6;
  float cvss_score = 7;

  cve.v1.CVE cve = 8 [features.field_presence = EXPLICIT];
  repeated string cwe_list = 9;

  // deduplication
  bool is_latest = 10;
  repeated Defect defect_duplicates = 11;

  // membership attributes
  bytes component_uuid = 20 [features.field_presence = EXPLICIT];
  uint32 application_id = 21 [features.field_presence = EXPLICIT];

  // git ref of an application to define where defect was found
  string application_ref = 22 [features.field_presence = EXPLICIT];

  // additional information about defect
  repeated string reference_url_list = 30;
  FixInfo fix_info = 31 [features.field_presence = EXPLICIT];

  google.protobuf.Timestamp created_at = 41 [features.field_presence = EXPLICIT];
  google.protobuf.Timestamp updated_at = 42 [features.field_presence = EXPLICIT];
}

enum DefectType {
  option allow_alias = true;

  DEFECT_TYPE_UNSPECIFIED = 0;

  DEFECT_TYPE_SAST = 1; // static source code analysis defects
  DEFECT_TYPE_SECRETS = 1; // found secrets (api keys, passwords) in source code or on host

  DEFECT_TYPE_DAST = 3; // dynamic testing (dast) defects
  DEFECT_TYPE_FUZZING = 3; // dynamic testing (fuzzing) defects

  DEFECT_TYPE_MAST = 4; // mobile dynamic testing defects

  DEFECT_TYPE_PENTEST = 6; // penetration testing defects

  DEFECT_TYPE_OSA = 7; // defects found in open source packages
  DEFECT_TYPE_SCA = 7; // software composition (packages and libraries) defects

  DEFECT_TYPE_IAC = 8; // infrastructure as code configuration file defects (Dockerfiles, Terraform, Helm and others)

  DEFECT_TYPE_ARCH = 9; // insecure architecture defect
  DEFECT_TYPE_CODE_REVIEW = 10; // security defect during code review
}

enum DefectStatus {
  DEFECT_STATUS_UNSPECIFIED = 0;

  DEFECT_STATUS_INDIRECT = 1; // defect is indirect for scanner application
  DEFECT_STATUS_DIRECT = 2; // defect is found directly in a scanned application

  DEFECT_STATUS_FIXED_BY_UPDATE = 3; // defect is removed by library/package update
  DEFECT_STATUS_WILL_NOT_FIX = 4; // defect is purposely left in code by distributor
  DEFECT_STATUS_END_OF_LIFE = 5; // defect is found in no longer supported (EOL) package
  DEFECT_STATUS_HAS_EXPLOIT = 6; // defect has known exploit
}