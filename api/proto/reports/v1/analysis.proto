edition = "2023";

package dolina.reports.v1;

option go_package = "gitlab.domsnail.ru/dolina/dolina-aspm-api/api/gen/go/reports/v1;reports_v1";
option features.(pb.go).api_level = API_OPAQUE;

import "protoc-gen-openapiv2/options/annotations.proto";
import "google/protobuf/go_features.proto";

import "google/protobuf/timestamp.proto";
import "google/protobuf/duration.proto";
import "reports/v1/scanners.proto";

message AnalyzeOptions {
  option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_schema) = {
    json_schema: {
      title: "Analyze options"
      description: "Contextual metadata accompanying a raw scanner report. It provides information "
          "about the environment in which the scan was executed, such as the repository URL, "
          "Git reference (branch, tag, commit), pipeline or build ID, and any other relevant "
          "deployment or runtime context. This data is used by Dolina ASPM to enrich, filter, "
          "and correlate findings with specific code versions or build stages."
    }
  };

  repeated ScannerReport scanner_reports = 1;

  // create or update project repository by provided attributes
  string repository_uuid = 2 [features.field_presence = EXPLICIT];
  string repository_url = 3 [features.field_presence = EXPLICIT]; // ignored if repository_uuid is provided
  string repository_ref = 4 [features.field_presence = EXPLICIT]; // added to repository data (can be branch or tag)

  // create or update project artifact by provided attributes
  string artifact_uuid = 5 [features.field_presence = EXPLICIT];
  string artifact_purl = 6 [features.field_presence = EXPLICIT]; // ignored if artifact_uuid is provided

  // ci/cd attributes
  string pipeline_id = 7 [features.field_presence = EXPLICIT];
  uint32 upload_window = 8 [features.field_presence = EXPLICIT]; // defines how long to delay processing

  // defines if non-existing entities (projects, repositories or artifacts) will be created
  bool auto_create = 9;
}

message AnalysisStatus {
  string report_uuid = 1;

  repeated ScannerReport scanner_reports = 2;

  string pipeline_id = 3 [features.field_presence = EXPLICIT];

  string project_id = 4 [features.field_presence = EXPLICIT];
  string repository_uuid = 5 [features.field_presence = EXPLICIT];
  string artifact_uuid = 6 [features.field_presence = EXPLICIT];

  uint32 worker_id = 7 [features.field_presence = EXPLICIT];

  AnalysisState current_state = 8;
  bool is_done = 9;
  float progress = 10 [features.field_presence = EXPLICIT];

  google.protobuf.Timestamp created_at = 11 [features.field_presence = EXPLICIT];
  google.protobuf.Timestamp started_at = 12 [features.field_presence = EXPLICIT];
  google.protobuf.Timestamp ended_at = 13 [features.field_presence = EXPLICIT];
  google.protobuf.Duration elapsed_duration = 14;
}

enum AnalysisState {
  ANALYSIS_STATE_UNSPECIFIED = 0;

  ANALYSIS_STATE_NOT_STARTED = 1; // analysis job in a queue
  ANALYSIS_STATE_ASSIGNED = 2; // worker is assigned
  ANALYSIS_STATE_IN_PROGRESS = 3; // worker is processing
  ANALYSIS_STATE_VERIFICATION = 4; // worker is verifying and sends analysis results
  ANALYSIS_STATE_DONE = 5; // analysis is done and results are saved

  ANALYSIS_STATE_ERROR = 6; // analysis is finished with error
  ANALYSIS_STATE_TIMEOUT = 7; // analysis is finished with timeout
  ANALYSIS_STATE_CANCELED = 8; // analysis is cancel by user
}