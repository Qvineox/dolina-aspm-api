stages:
  - publish
  - prettify

bump tag:
  stage: publish
  image:
    name: ${CI_DEPENDENCY_PROXY_GROUP_IMAGE_PREFIX}/alpine/git:v2.52.0
    entrypoint: [ "" ]
  rules:
    - changes:
        - api/**/*
  before_script:
    - AUTHOR_NAME="${GITLAB_USER_NAME:-$(git log -1 --pretty='%an')}"
    - AUTHOR_EMAIL="${GITLAB_USER_EMAIL:-$(git log -1 --pretty='%ae')}"
    - git config --global user.name "${AUTHOR_NAME}"
    - git config --global user.email "${AUTHOR_EMAIL}"
    - echo "Using Git identity = ${AUTHOR_NAME} <${AUTHOR_EMAIL}>"

    - git fetch --unshallow || true
    - git fetch --tags
  script:
    # get latest tag, default to 0.0.0 if none
    - LATEST_TAG=$(git tag --list 'v*' --sort=-version:refname | head -n1 || echo "v0.0.0")
    - echo "Latest tag = $LATEST_TAG"

    # simple patch bump: X.Y.Z -> X.Y.(Z+1)
    - LATEST_VER=$(echo "$LATEST_TAG" | sed 's/^v//')
    - set -- $(echo "$LATEST_VER" | tr '.' ' ')
    - MAJOR_VER="$1"
    - MINOR_VER="$2"
    - PATCH_VER="$3"
    - PATCH_VER=$((PATCH_VER + 1))
    - NEW_TAG="v${MAJOR_VER}.${MINOR_VER}.${PATCH_VER}"
    - echo "New tag = ${NEW_TAG}"

    - git tag -a "${NEW_TAG}" -m "Auto-bump tag ${NEW_TAG} on commit $(git rev-parse HEAD)"
    - git push "https://gitlab-ci-token:${CI_JOB_TOKEN}@${CI_SERVER_HOST}/${CI_PROJECT_PATH}.git" "${NEW_TAG}"

    - echo "LATEST_TAG=${NEW_TAG}" >> latest_tag.env
  tags:
    - docker
  artifacts:
    reports:
      dotenv: latest_tag.env

set tag badge:
  stage: prettify
  image:
    name: ${CI_DEPENDENCY_PROXY_GROUP_IMAGE_PREFIX}/alpine/curl:8.17.0
    entrypoint: [ "" ]
  needs:
    - job: bump tag
      artifacts: true
  script:
    - echo "Latest Go tag = $LATEST_TAG"

    # Create badge via GitLab API (pure curl, no jq)
    - |
      curl --fail --request PUT \
        --header "PRIVATE-TOKEN: $CI_JOB_TOKEN" \
        --header "Content-Type: application/x-www-form-urlencoded" \
        --data-urlencode "name=Golang%20Package%20Version" \
        --data-urlencode "link_url=https://$CI_SERVER_HOST/$CI_PROJECT_PATH/-/releases" \
        --data-urlencode "image_url=https://$CI_SERVER_HOST/$CI_PROJECT_PATH/badges/${CI_PIPELINE_ID}/go-tag.svg?style=flat-square&label=go%20pkg&message=${LATEST_TAG}&color=teal&labelColor=blueviolet" \
        "https://$CI_SERVER_HOST/api/v4/projects/$CI_PROJECT_ID/badges/${CI_PIPELINE_ID}"
  artifacts:
    reports:
      dotenv: badge-url.env